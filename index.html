<html>
    <head>
        <style>
            * {
                font-size: 110%;
            }
        </style>
        <title>Shock collar control</title>
    </head>
    <body>
        <h1>Shock Collar control</h1>
        <form id="form">
            <label for="mode">Mode</label>
            <select name="mode" id="mode">
            </select>
            <br>
            <label for="level" id="levelLabel"></label>
            <input name="level" id="level" type="range" min="1" max="30" step="1" value="1"><output id="level-out">1</output>
            <br>
            <button id="submit" type="submit">Send ðŸ”Š</button>
        </form>
        <script>
            $capabilities$
            const form = document.getElementById('form');
            const levelInput = document.getElementById('level');
            levelInput.max = capabilities.maxLevel;
            const levelLabel = document.getElementById('levelLabel');
            levelLabel.textContent = `Level (limited by server to ${capabilities.maxLevel} (of 100))`;

            const modeInput = document.getElementById('mode');

            for(const cap of capabilities.permissions) {
                const opt = document.createElement('option');
                opt.value = cap;
                opt.textContent = cap[0].toUpperCase() + cap.slice(1);
                modeInput.appendChild(opt);
            }

            const levelOutput = document.getElementById('level-out');
            const submit = document.getElementById('submit');
            const icons = {
                beep: 'ðŸ”Š',
                shock: 'âš¡',
                vibrate: 'ðŸ“³'
            }
            function setInputLock(locked) {
                Array.from(form.querySelectorAll('input,select,button')).forEach(e => {
                    e.disabled = locked;
                });
            }
            function updateSend() {
                const mean = levelInput.valueAsNumber >= capabilities.maxLevel/2 && modeInput.value === 'shock';
                submit.innerText = `Send ${icons[modeInput.value]} ${mean ? '>:3' : ''}`;
            }
            levelInput.addEventListener('input', ev => {
                levelOutput.value = levelInput.value;
                updateSend();
            });
            modeInput.addEventListener('change', updateSend);
            form.addEventListener('submit', ev => {
                ev.preventDefault();
                setInputLock(true);
                Promise.all([
                    new Promise(res => setTimeout(res, 2500)),
                    fetch('/', {
                        method: 'post',
                        body: `${modeInput.value},${levelInput.value}`,
                    })
                    .then(r => {
                        if (r.status === 401) {
                            setInputLock(true);
                            alert('Wrong password, please reload and enter again (I am lazy).');
                            throw new Error('disabled :3');
                        }
                    })
                ])
                .then(() => {
                    setInputLock(false);
                })
            })
        </script>
    </body>
</html>